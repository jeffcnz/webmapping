<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="description" content="Interactive map showing water take information in the Hawke's Bay.">
	<meta name="keywords" content="Water take, Hawke's Bay, Regional Council, Consent, HBRC, meter">
	<meta name="author" content="Jeff Cooke">
	
	<title>HBRC Water Take Consents</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <!-- Load Leaflet from CDN-->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-1.0.0-b1/leaflet.css" />
    <!--Leaflet-->
    <script src="http://cdn.leafletjs.com/leaflet-1.0.0-b1/leaflet.js"></script>
    
    <!-- Esri Leaflet -->
     <script src="http://cdn.jsdelivr.net/leaflet.esri/2.0.0-beta.6/esri-leaflet.js"></script>
    
    <!-- Esri Leaflet Geocoder not picking up options if use links to cdn-->
    <link rel="stylesheet" href="lib/esri_leaflet_geocoder/esri-leaflet-geocoder.css">
    <script src="lib/esri_leaflet_geocoder/esri-leaflet-geocoder.js"></script>
    
    <!--Leaflet locate-->
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.min.js'></script>
	<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.mapbox.css' rel='stylesheet' />
	<!--[if lt IE 9]>
		<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.ie.css' rel='stylesheet' />
	<![endif]-->
	<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/css/font-awesome.min.css' rel='stylesheet' />


	<!--Leaflet sidebar-->
	<script src='lib/leaflet_sidebar/L.Control.Sidebar.js'></script>
	<link href='lib/leaflet_sidebar/L.Control.Sidebar.css' rel='stylesheet' />
<!--[if lt IE 9]>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.ie.css' rel='stylesheet' />
<![endif]-->
	<!--link href='lib/font-awesome-4.5.0/css/font-awesome.min.css' rel='stylesheet' /-->
    
    
    <link rel="stylesheet" type="text/css" href="css/borestyle.css"></link>
</head>

<body>
	
    <div id="map" class="map" >
    <div id="loading"><i class="fa fa-spinner fa-spin"></i></div>
    </div>
    <div id="info"></div>
    
    
    <script>
    //Open a map container and centre in the Hawke's Bay (Omahu Rd Expressway roundabout) at zoom 14
		var map = L.map('map').setView([-39.620363,176.816379], 14);

	//Bring in the basemap

	
	//Esri basemap and transportation overlay
		L.esri.basemapLayer('Imagery').addTo(map);
		L.esri.basemapLayer('ImageryTransportation').addTo(map);

		var currentQuery = "Status IN ('Current','S124 Expired/Exercised') and Type='Water Permit'";//SQL statement to limit results
		var featureUrl = 'https://hbrcwebmap.hbrc.govt.nz/arcgis/rest/services/ConsentCurrentWaterTakePointMetersWeb/MapServer/0/';//url of feature service
		var credits = '<a href="https://hbrcwebmap.hbrc.govt.nz/arcgis/rest/services/ConsentCurrentWaterTakePointMetersWeb/MapServer">Data from HBRC</a>'
	//Overlay with an ESRI feature layer showing water take consents, radius 10 for mobile screens so easier to hit with big fingers.
		var hbconsents = L.esri.featureLayer({
			url: featureUrl,
			//url: 'https://hbrcwebmap.hbrc.govt.nz/arcgis/rest/services/HBRCResourceConsentsWeb/FeatureServer/0/',
			pointToLayer: function (geojson, latlng) {return L.circleMarker(latlng, 
				{radius: 10,
				stroke: false,
				fillColor: '#43a2ca',
				fillOpacity: 0.8}
				);},
			//where: currentQuery,
			onEachFeature: onEachFeature //the function to call when a feature is interacted with
			}).addTo(map);
		//Add attribution for the feature layer
		map.attributionControl.addAttribution(credits);

	//Geocoding and search control
		//Define the location geocoding service, from esri, limited to New Zealand
		var arcgisOnline = L.esri.Geocoding.arcgisOnlineProvider({
			countries: ['NZL',],
			categories: ['Address', 'Postal', 'Populated Place', ]
			});
		
		//Define the feature search (geocoding service), search consent number and bore number		
		var hbcons = L.esri.Geocoding.featureLayerProvider({
			url: featureUrl,
			searchFields: ['ConsentNumber', 'WellNumber'], // Search these fields for text matches
			label: 'Water Takes', // Group suggestions under this header
			formatSuggestion: function(feature){
				return feature.properties.ConsentNumber + ' - Bore ' + feature.properties.WellNumber; // format suggestions like this.
				}
			});

		// create the geocoding control and add it to the map
		var consentSearch = L.esri.Geocoding.geosearch({
			providers: [arcgisOnline, hbcons],
			position: 'topright',
			useMapBounds: false,
			placeholder: 'Search for Consents, Bores or Addresses' 
			}).addTo(map);

		var loading = L.control();
		
		loading.onAdd = function (map) {
			this._div = L.DomUtil.create('div', 'loadicon');
			this._div.innerHTML = '<i class="fa fa-spinner fa-2x fa-spin"></i>';
			return this._div;
			};
		
		
		
		// create an empty layer group to store the results and add it to the map
		var results = L.layerGroup().addTo(map);

		// listen for the results event and add every result to the map
		consentSearch.on("results", function(data) {
			lc.stop();//stops location services, info wasn't displaying if location and search results active at same time, may need reassessed
			results.clearLayers();
			for (var i = data.results.length - 1; i >= 0; i--) {
				results.addLayer(L.marker(data.results[i].latlng));
				};
			});
			
	//Feature layer listner function
	function onEachFeature(feature, layer) {
		layer.on({
			//mouseover: highlightFeature,
			//mouseout: resetHighlight,
			click: infoFeature
			});
		}
		
	//Function to update the information panel
	function infoFeature(e) {
		hbconsents.setStyle({fillColor: '#43a2ca'});//reset all features to default colour
		hbconsents.setFeatureStyle(e.target.feature.id, {fillColor: '#ff0000'});//highlight selected feature
		featureQuery(e.target._latlng);
		}
		
	var featureInfo = {};
	var i = 0;
	
		
	function featureQuery(pointObject) {
		loading.addTo(map);
		i = 0;
		featureInfo = {};
		hbconsents.query().nearby(pointObject, 1).where(currentQuery).run(function(error, featureCollection){
				loading.getContainer().innerHTML='';
				if (featureCollection.features.length > 0){
					featureInfo = featureCollection.features;
					info.update(featureInfo[i].properties)
					};
				});
		}
	
	//Create the information panel and add info to it
	var info = L.control.sidebar('info', {
    position: 'right'
});
	map.addControl(info);
	
	//function to advance one record, when a button is pressed
	function forwardOne(){
		if (i<(featureInfo.length - 1)){i = i + 1}
		else {i=0};
		info.update(featureInfo[i].properties);
		}
	//function to go back one record when a button is pressed
	function backOne(){
		if (i>0){i = i - 1}
		else {i=(featureInfo.length - 1)};
		info.update(featureInfo[i].properties);
		}
	
	//helper function that checks how many records there are and if there are more than one displays buttons andinformation to aid navigation.
	function checkButtons(){
		var outstr = ''
		if (featureInfo.length > 1){outstr = '<button type = "button" name ="backButton" onclick = "backOne()"><b><</b></button>    Record ' + (i+1) + ' of ' + featureInfo.length + '   <button type = "button" id ="nextButton" onclick = "forwardOne()"><b>></b></button>'};
		return outstr;
		}
	
	// method that updates the control based on feature properties passed.
	info.update = function (props) {
		info.setContent(checkButtons() +
			'<table><tr><td><h4>Consent Details</h4></td></tr>' +  
			'<tr><td><b>Consent: </td><td>' + props.ConsentNumber + '</td></b></tr>'+
			'<tr><td>Bore: </td><td>' + checkDefined(props.WellNumber) + '</td></tr>'+
			'<tr><td>Water Use: </td><td>' + props.UseDetail +'</td></tr>'+
			'<tr><td> </td><td>' + '</td></tr>'+
			'<tr><td>Recording frequency: </td><td>' + checkDefined(props.WMDRecordingFrequency) +'</td></tr>'+
			'<tr><td>Return method: </td><td>' + checkDefined(props.WaterUseReturnMethod) +'</td></tr>'+
			'<tr><td>Return frequency: </td><td>' + checkDefined(props.WaterUseReturnFrequency) +'</td></tr>'+
			'<tr><td> </td><td>' + '</td></tr></table>'+
			'<table><tr><td>Max. weekly volume </td><td class="value">' + checkDefined(props.ConsentMaxWeeklyTake) +'</td><td class="units"> m<sup>3</sup>/week</td></tr>'+
			'<tr><td>Max. 28 day volume </td><td class="value">' + checkDefined(props.ConsentMax28DayTake) +'</td><td class="units"> m<sup>3</sup>/28 days</td></tr>'+
			'<tr><td>Max. monthly volume</td><td class="value">' + checkDefined(props.ConsentMaxMonthlyTake) +'</td><td class="units"> m<sup>3</sup>/month</td></tr>'+
			'<tr><td>Max. annual volume </td><td class="value">' + checkDefined(props.ConsentMaxAnnualTake) +'</td><td class="units"> m<sup>3</sup>/year</td></tr>'+
			'<tr><td>Max. consented take rate </td><td class="value">' + checkDefined(props.ConsentMaxTakeRate) +'</td><td class="units"> l/s </td></tr>'+
			'<tr><td> </td><td>' + '</td></tr>'+
			'<tr><td><h4>Water Meter Details</h4></td><td></tr>' + 
			'<tr><td>Meter required? </td><td class="value">' + props.WaterMeterRequired + '</td></tr>'+
			'<tr><td>Meter required by </td><td class="value">' + checkDefined(props.WaterMeterRequiredDate) +'</td></tr>'+
			'<tr><td>Meter installed? </td><td class="value">' + props.WaterMeterInstalled +'</td></tr>'+
			'<tr><td>Meter installed on  </td><td class="value">' + checkDefined(props.WaterMeterInstallationDate) +'</td></tr>'+
			'<tr><td> </td></tr>'+
			'<tr><td>HBRC Meter Name </td><td class="value">' + checkDefined(props.MeterName) +'</td></tr>'+
			'<tr><td>Meter Serial Number </td><td class="value">' + checkDefined(props.SerialNo) +'</td></tr>'+
			'<tr><td>Meter verification date </td><td class="value">' + checkDefined(props.WaterMeterVerificationDate) +'</td></tr>'+
			'<tr><td>Measured error </td><td class="value">' + checkDefined(props.WaterMeterVerifyErrorPercentage) +'</td><td class="units">%</td></tr>'+
			'<tr><td>Verification Status: </td><td class="value">' + checkDefined(props.WaterMeterVerificationPassFail) +'</td></tr>'+
			'<tr><td> </td></tr>'+
			'<tr><td>Telemetry required? </td><td class="value">' + props.TelemetryRequired +'</td></tr>'+
			'<tr><td>Telemetry required by </td><td class="value">' + checkDefined(props.TelemetryRequiredDate) +'</td></tr>'+
			'<tr><td>Telemetry installed on </td><td class="value">' + checkDefined(props.TelemetryInstalledDate) +'</td></tr>'+
			'</table>'
			); 
			info.show();
		};

	
	
	//Helper function that checks there is a value, if undefined or null then replaces with a blank
	function checkDefined(property) {
		if (property) {return property} else {return ' '};
		}
		
		
	//Location control and handler
	lc = L.control.locate({
		follow: true,
		icon: 'fa fa-map-marker',
		keepCurrentZoomLevel: false,
		strings: {
			title: "Show me where I am"
			},
		locateOptions: {
			}
		}).addTo(map);
	
	//Stop following if the user drags the map
	map.on('startfollowing', function() {
		map.on('dragstart', lc._stopFollowing, lc);
	}).on('stopfollowing', function() {
		map.off('dragstart', lc._stopFollowing, lc);
	});


    </script>
</body>
</html>
